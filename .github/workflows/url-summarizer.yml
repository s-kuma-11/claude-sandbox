name: URL Summarizer

on:
  issues:
    types: [opened, edited]
  issue_comment:
    types: [created, edited]

jobs:
  summarize:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      id-token: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          claude_args: '--allowedTools WebFetch,Bash(gh:*),Bash(curl:*)'
          prompt: |
            以下のテキストにURLが含まれているか確認してください。

            イベント: ${{ github.event_name }}
            Issue番号: ${{ github.event.issue.number }}
            ${{ github.event_name == 'issues' && format('Issue本文: {0}', github.event.issue.body) || format('コメントID: {0}\nコメント本文: {1}', github.event.comment.id, github.event.comment.body) }}

            URLが含まれている場合:
            1. 各URLにアクセスして内容を取得する
            2. 日本語で要約を作成する（300〜500文字程度）。記事の主なポイントや結論を含めること
            3. 元のテキストの末尾に要約を追記して編集する
               - issueの場合: gh issue edit ${{ github.event.issue.number }} --body "{元の本文}\n\n---\n### URL要約\n**{URL}**\n{要約}"
               - コメントの場合: gh api repos/${{ github.repository }}/issues/comments/{コメントID} --method PATCH --field body="{元のコメント本文}\n\n---\n### URL要約\n**{URL}**\n{要約}"

            URLが含まれていない場合、またはすでに「### URL要約」が含まれている場合は何もしないでください。